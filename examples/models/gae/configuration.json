{
    "datasets": {
        "training": {
            "filename": "/home/hecht/build/thesis/datasets/train_ds_40000000_32_0.tfrec",
            "size": 40000000,
            "steps":100000,
            "epochs": 1
        },
        "batch":256,
        "features":[
            {
                "shape": [32,32,3],
                "key": "patch",
                "dtype": "tf.float32"
            },
            {
                "shape": [1],
                "key": "label",
                "dtype": "tf.int64"
            }
        ]
    },
    "model": {
        "inputs":{
            "features":[
                {
                    "shape": [32,32,3],
                    "key": "patch",
                    "dtype": "tf.float32"
                }
            ],
            "labels": {
                "shape": [1],
                "dtype": "tf.int64",
                "num_classes": 9,
                "names": ["HE","CD3","CD8","PD1","FOXP3","CD45RO","CAIX","PDL1","CD68"]
            }
        },
        "parameters": {
            "beta": 5,
            "alpha": 1,
            "delta": 1,
            "stain_code_size":6
        },
        "components": [      
            {
                "name":"encoder",
                "input": "patch",
                "layers": [
                    {
                        "type":"resnet_v2_block",
                        "stride":1,
                        "base_depth":12,
                        "num_units": 1
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },                    
                    {
                        "type":"max_pool",
                        "pool_size":[2,2],
                        "strides":[2,2]
                    },
                    {
                        "type":"resnet_v2_block",
                        "stride":1,
                        "base_depth":12,
                        "num_units": 1
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },                   
                    {
                        "type":"max_pool",
                        "pool_size":[2,2],
                        "strides":[2,2]
                    },
                    {
                        "type":"resnet_v2_block",
                        "stride":1,
                        "base_depth":12,
                        "num_units": 1
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type":"max_pool",
                        "pool_size":[2,2],
                        "strides":[2,2]
                    },
                    {
                        "type":"resnet_v2_block",
                        "stride":1,
                        "base_depth":12,
                        "num_units": 1
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type":"max_pool",
                        "pool_size":[2,2],
                        "strides":[2,2]
                    },
                    {
                        "type":"resnet_v2_block",
                        "stride":1,
                        "base_depth":12,
                        "num_units": 1
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type":"max_pool",
                        "pool_size":[2,2],
                        "strides":[2,2]
                    }
                ],
                "output":"encoded_patch"
            },
            {
                "name":"sampler",
                "input":"encoded_patch",
                "layers": [
                    {
                        "type":"sampler",
                        "dims":18,
                        "name":"z"
                    }
                ],
                "output":["mean","log_sigma_sq", "code"]
            },
            {
                "name":"classifier",
                "input": "code",
                "layers":[
                    {
                        "type":"flatten"
                    },
                    {
                        "type":"slice",
                        "begin":[0],
                        "size":[6]
                    },
                    {
                        "type":"dense",
                        "units":9,
                        "activation":"tf.nn.sigmoid",
                        "trainable": false
                    }
                ],
                "output":"predictions_classifier"
            },
            {
                "name":"discriminator",
                "input": "code",
                "layers":[
                    {
                        "type":"flatten"
                    },
                    {
                        "type":"slice",
                        "begin":[5],
                        "size":[12]
                    },
                    {
                        "type":"dense",
                        "units":9,
                        "activation":"tf.nn.sigmoid",
                        "trainable": false
                    }
                ],
                "output":"predictions_discriminator"
            },
            {
                "name": "decoder",
                "input":"code",
                "layers": [                    
                    {
                        "type":"conv",
                        "filters": 32,
                        "padding": "valid",
                        "kernel_size": [2,2],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type":"conv",
                        "filters": 32,
                        "padding": "valid",
                        "kernel_size": [3,3],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type":"conv",
                        "filters": 32,
                        "kernel_size": [3,3],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type": "avg_unpool",
                        "factor":2
                    },
                    {
                        "type":"conv",
                        "filters": 32,
                        "kernel_size": [3,3],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type": "avg_unpool",
                        "factor":2
                    },                    
                    {
                        "type":"conv",
                        "filters": 32,
                        "kernel_size": [3,3],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type": "avg_unpool",
                        "factor":2
                    },
                    {
                        "type":"conv",
                        "filters": 32,
                        "kernel_size": [3,3],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    },
                    {
                        "type":"batch_norm",
                        "axis": [-1]
                    },
                    {
                        "type":"activation",
                        "function":"tf.nn.relu"
                    },
                    {
                        "type":"conv",
                        "filters": 3,
                        "kernel_size": [1,1],
                        "strides":[1,1],
                        "transpose": true,
                        "trainable":false
                    }
                ],
                "output":"logits"
            }
        ],
        "embeddings": {
            "width": 32,
            "height": 32,
            "stain_code_size": 6
        }
    }
}

